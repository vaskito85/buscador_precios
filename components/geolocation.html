
<!-- components/geolocation.html -->
<div style="margin: 8px 0;">
  <button id="geo-btn" style="
    background:#4CAF50;color:#fff;border:none;border-radius:8px;
    padding:10px 16px;font-size:16px;cursor:pointer;">
    üìç Usar mi ubicaci√≥n actual
  </button>
  <span id="geo-status" style="margin-left:10px;color:#888;font-size:14px;"></span>
</div>

<script>
(function(){
  const btn = document.getElementById('geo-btn');
  const statusEl = document.getElementById('geo-status');

  function setStatus(msg, color='#888') {
    statusEl.textContent = msg;
    statusEl.style.color = color;
  }

  function updateQueryParams(lat, lon) {
    try {
      const url = new URL(window.location.href);
      url.searchParams.set('lat', String(lat));
      url.searchParams.set('lon', String(lon));
      // Recarga con nuevos params; Streamlit leer√° st.query_params
      window.location.assign(url.toString());
    } catch (e) {
      setStatus('Error actualizando la URL', '#d9534f');
      console.error(e);
    }
  }

  function onSuccess(pos) {
    const { latitude, longitude } = pos.coords;
    const lat = Number(latitude.toFixed(6));
    const lon = Number(longitude.toFixed(6));
    setStatus(`Lat: ${lat}, Lon: ${lon} (OK)`, '#4CAF50');
    updateQueryParams(lat, lon);
  }

  function onError(err) {
    console.warn(err);
    switch(err.code){
      case err.PERMISSION_DENIED:
        setStatus('Permiso denegado. Habilit√° el acceso a ubicaci√≥n.', '#d9534f'); break;
      case err.POSITION_UNAVAILABLE:
        setStatus('Posici√≥n no disponible.', '#d9534f'); break;
      case err.TIMEOUT:
        setStatus('Tiempo excedido obteniendo la ubicaci√≥n.', '#d9534f'); break;
      default:
        setStatus('Error de geolocalizaci√≥n.', '#d9534f');
    }
  }

  btn.addEventListener('click', function(){
    setStatus('Obteniendo ubicaci√≥n‚Ä¶');
    if (!navigator.geolocation) {
      setStatus('Geolocalizaci√≥n no soportada por el navegador.', '#d9534f');
      return;
    }
    navigator.geolocation.getCurrentPosition(onSuccess, onError, {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    });
  });
})();
</script>
